<!DOCTYPE html>
<html>
<head>
    <title>AK-47 Model Test</title>
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a1a; }
        canvas { display: block; }
        #info { 
            position: absolute; 
            top: 10px; 
            left: 10px; 
            color: white; 
            font-family: monospace;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 5px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .error { color: #ff6b6b; }
        .success { color: #51cf66; }
        .warning { color: #ffd43b; }
    </style>
</head>
<body>
    <div id="info">
        <h3>AK-47 Model Texture Test</h3>
        <div id="status">Loading...</div>
    </div>
    
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>
    
    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        
        const status = document.getElementById('status');
        
        function log(msg, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = msg;
            status.appendChild(div);
            console.log(msg);
        }
        
        // Scene setup
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a1a);
        
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(3, 1, 2);
        
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.target.set(0, 0, 0);
        
        // Lighting
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.position.set(5, 5, 5);
        scene.add(directionalLight);
        
        // Load model
        const loader = new GLTFLoader();
        log('Loading weapon_rif_ak47.gltf...');
        
        loader.load(
            '/models/ak47/weapon_rif_ak47.gltf',
            (gltf) => {
                log('✅ GLTF loaded successfully', 'success');
                scene.add(gltf.scene);
                
                // Center and scale
                const box = new THREE.Box3().setFromObject(gltf.scene);
                const center = box.getCenter(new THREE.Vector3());
                const size = box.getSize(new THREE.Vector3());
                
                gltf.scene.position.sub(center);
                const maxDim = Math.max(size.x, size.y, size.z);
                const scale = 0.3 / maxDim;
                gltf.scene.scale.setScalar(scale);
                
                log(`Model size: ${size.x.toFixed(2)} x ${size.y.toFixed(2)} x ${size.z.toFixed(2)}`);
                log(`Scale: ${scale.toFixed(4)}`);
                
                // Analyze materials and textures
                log('\n=== MATERIALS ANALYSIS ===', 'success');
                let meshCount = 0;
                
                gltf.scene.traverse((child) => {
                    if (child.isMesh) {
                        meshCount++;
                        log(`\nMesh ${meshCount}: ${child.name}`);
                        
                        const mat = child.material;
                        if (mat) {
                            log(`  Material: ${mat.name || 'unnamed'}`);
                            
                            if (mat.map) {
                                log(`  ✅ Base color texture: ${mat.map.image?.src || 'embedded'}`, 'success');
                                if (!mat.map.image) {
                                    log(`  ⚠️ Texture has NO image!`, 'error');
                                }
                            } else {
                                log(`  ❌ NO base color texture`, 'error');
                            }
                            
                            if (mat.normalMap) {
                                log(`  ✅ Normal map`, 'success');
                            } else {
                                log(`  ⚠️ No normal map`, 'warning');
                            }
                            
                            if (mat.roughnessMap || mat.metalnessMap) {
                                log(`  ✅ PBR maps present`, 'success');
                            }
                            
                            log(`  Color: rgb(${mat.color.r.toFixed(2)}, ${mat.color.g.toFixed(2)}, ${mat.color.b.toFixed(2)})`);
                        } else {
                            log(`  ❌ NO material!`, 'error');
                        }
                    }
                });
                
                log(`\nTotal meshes: ${meshCount}`, 'success');
            },
            (progress) => {
                const percent = (progress.loaded / progress.total * 100).toFixed(0);
                log(`Loading: ${percent}%`);
            },
            (error) => {
                log(`❌ Error loading GLTF: ${error.message}`, 'error');
            }
        );
        
        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();
        
        // Handle resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
